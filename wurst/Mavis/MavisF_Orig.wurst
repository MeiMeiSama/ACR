package MavisF_Orig
import DamageEvent
import AbilityGlobals
import ObjectDefinitions
import ChannelAbilityPreset
import UnitIds
import main
import ClosureForGroups

unit mavis
unit dummyUnit
unit dummyUnit2
unit dummyUnit3
vec2 spellPos
vec2 mavisPos
integer mavisFInt
group mavisGroup 

@compiletime function createAbility()
    new ChannelAbilityPreset(MAVIS_F, 1, true)
        ..presetTargetTypes(Targettype.POINT)
        ..setAnimationNames("11111")
        ..setButtonPositionNormalX(2)
        ..setButtonPositionNormalY(1)
        ..setButtonPositionResearchX(1)
        ..setButtonPositionResearchY(1)
        ..setIconNormal("ReplaceableTextures\\CommandButtons\\BTNRockGolem.blp")
        ..setIconResearch("ReplaceableTextures\\CommandButtons\\BTNRockGolem.blp")
        ..setMissileSpeed(99999)
        ..setHeroAbility(true)
        ..setHotkeyNormal("F")
        ..setHotkeyLearn("F")
        ..setLevels(1)
        ..presetArtDuration(lvl -> 0)
        ..presetBaseOrderID(lvl -> "tranquility")
        ..presetDisableOtherAbilities(lvl -> false)
        ..presetFollowThroughTime(lvl -> 0)
        ..presetCastRange(lvl -> 2000)
        ..presetCooldown(lvl -> 50)
        ..presetManaCost(lvl -> 70)
        ..presetTargetsAllowed(lvl -> "enemy,ground,air,neutral")
        ..presetTooltipNormal(lvl -> "Illusionary Battalion|r")
        ..presetTooltipNormalExtended(lvl -> "Misogi F Desc|r")
        ..setTooltipLearn("Illusionary Battalion|r")
        ..setTooltipLearnExtended("Learning F|r")
    new UnitDefinition(MAVIS_F_DUMMY, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\Edolas01.mdl")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(MAVIS_F_DUMMY2, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\Edolas01.mdl")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(MAVIS_F_DUMMY3, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\Edolas01.mdl")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")        

function initTrig_MavisF_Orig()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_SPELL_EFFECT)
    ..addCondition(Condition(function mavisCondition))
    ..addAction() ->
        mavis=GetTriggerUnit()
        spellPos = vec2(GetSpellTargetX(), GetSpellTargetY())
        mavisPos = mavis.getPos()
        if mavisGroup == null
            mavisGroup = CreateGroup()
        mavis.setInvulnerable(true)
        mavis.pause()
        SetUnitAnimation(mavis, "spell")
        soundPlay("war3mapImported\\Mavis F.mp3", 0, 0)
        dummyUnit = createUnit(mavis.getOwner(),MAVIS_F_DUMMY, mavisPos, mavis.getPos().angleTo(spellPos))
        SetUnitScale(dummyUnit,1.50,1.50,1.50)
        SetUnitTimeScalePercent(dummyUnit, 80)
        SetUnitAnimation(dummyUnit, "Spell One")
        dummyUnit2 = createUnit(mavis.getOwner(),MAVIS_F_DUMMY2, mavisPos, mavis.getPos().angleTo(spellPos))
        SetUnitScale(dummyUnit2,1.50,1.50,1.50)
        SetUnitTimeScalePercent(dummyUnit2, 80)
        SetUnitAnimation(dummyUnit2, "Spell One")
        dummyUnit3 = createUnit(mavis.getOwner(),MAVIS_F_DUMMY3, mavisPos, mavis.getPos().angleTo(spellPos))
        SetUnitScale(dummyUnit3,1.50,1.50,1.50)
        SetUnitTimeScalePercent(dummyUnit3, 80)
        SetUnitAnimation(dummyUnit3, "Spell One")
        mavisFInt=0
        CreateTimer()..startPeriodic(0.03, function mavisFEnd)

function mavisFEnd()
    mavisFInt=mavisFInt+60
    mavis.setInvulnerable(false)
    mavis.unpause()
    forUnitsInRange(dummyUnit.getPos(), 400) (unit victim) ->
        if victim.isType(UNIT_TYPE_STRUCTURE)==false and victim.isEnemyOf(mavis)==true and victim.isAlive()==true and mavisGroup.has(victim) == false and victim.isInvulnerable() == false
            DamageEvent.setNextDamageId(DAMAGE_ABILITY_F)
            DamageEvent.setNextDamageFromCode()
            UnitDamageTargetBJ(mavis, victim,(12*GetHeroInt(mavis,true)).toReal(),ATTACK_TYPE_MAGIC,DAMAGE_TYPE_MAGIC)
            mavisGroup.add(victim)
    if mavisFInt  >= 1350 or dummyUnit3.getPos().distanceTo(spellPos) <= 20         
        addEffect("war3mapImported\\LIGHT3.mdx", dummyUnit3.getPos())
        ..setScale(0.70)
        ..destr()
        dummyUnit.remove()
        dummyUnit2.remove()
        dummyUnit3.remove()
        GetExpiredTimer().destr()
        mavis=null
        mavisFInt=0
        mavisGroup.clear()    
    else
        dummyUnit.setPos(dummyUnit.getPos().polarOffset(dummyUnit.getPos().angleTo(spellPos), 70))        
        dummyUnit2.setPos(dummyUnit2.getPos().polarOffset(dummyUnit2.getPos().angleTo(spellPos), 80))        
        dummyUnit3.setPos(dummyUnit3.getPos().polarOffset(dummyUnit3.getPos().angleTo(spellPos), 90))  

function mavisCondition() returns boolean
    return GetSpellAbilityId() == MAVIS_F

init
    initTrig_MavisF_Orig()    
