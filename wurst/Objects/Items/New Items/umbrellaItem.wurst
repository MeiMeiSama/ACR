package umbrellaItem

import ObjectDefinitions
import TimerUtils

timer array umbrellaTimer
unit array umbrellaOwner

init
    umbrellaItemFunc()

function umbrellaItemFunc()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_PICKUP_ITEM)
    ..addAction() ->
        let id = GetTriggerUnit().getOwner().getId()
        umbrellaOwner[id] = GetTriggerUnit()
        if umbrellaTimer[id] == null
            umbrellaTimer[id] = CreateTimer()..startPeriodic(0.01, function umbrellaTimer)..setData(id)

    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_DROP_ITEM)
    ..addAction() ->
        let id = GetTriggerUnit().getOwner().getId()
        if umbrellaTimer[id] != null
            umbrellaTimer[id].destr()
            umbrellaTimer[id] = null
            


function umbrellaTimer()
    let id = GetExpiredTimer().getData()
    if umbrellaOwner[id].hasItemById(UMBRELLA_JOKES) and umbrellaOwner[id].isAlive()
        let maxHP = umbrellaOwner[id].getMaxHP()
        let currentHP = umbrellaOwner[id].getHP()
        if currentHP >= maxHP
            let regen = umbrellaOwner[id].getField(UNIT_RF_HIT_POINTS_REGENERATION_RATE)
            umbrellaOwner[id].addMana(regen)