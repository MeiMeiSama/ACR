package ManaBurnItem

import ObjectDefinitions
import TimerUtils
import ACR_TagSystem

int array manaBurnCount
unit array manaBurnCaster
unit array manaBurnVictim
real array manaBurnVictimMana
timer array manaBurnTimer

init
    manaBurnItemUse()
function manaBurnItemUse()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_SPELL_EFFECT)
    ..addAction() ->
        if GetSpellAbilityId() == MANA_BURN_ABILITY
            let victim = GetSpellTargetUnit()
            let id = victim.getOwner().getId()
            let caster = GetTriggerUnit()
            let maxMana = victim.getMaxMana()
            let manaToBurn = maxMana * 0.35
            let damage = manaToBurn / 3.0
            victim.setMana(victim.getMana() - manaToBurn)
            caster.damageTarget(victim, damage, ATTACK_TYPE_MAGIC)
            manaBurnCount[id] = 0
            manaBurnCaster[id] = caster
            manaBurnVictim[id] = victim
            manaBurnVictimMana[id] = victim.getMana()
            if manaBurnTimer[id] == null
                manaBurnTimer[id] = CreateTimer()..startPeriodic(0.01, function manaBurnItemUseEnd)..setData(id)

function manaBurnItemUseEnd()
    let id = GetExpiredTimer().getData()
    if manaBurnVictim[id].isPaused() == false and manaBurnVictim[id].hasTagPauseEX() == false
        manaBurnCount[id]++
        if manaBurnVictim[id].getMana() > manaBurnVictimMana[id]
            manaBurnVictim[id].setMana(manaBurnVictimMana[id])
        if manaBurnCount[id] >= 300 or manaBurnVictim[id].isAlive() == false
            manaBurnTimer[id].destr()
            manaBurnTimer[id] = null


   