package Cloud

import ObjectDefinitions
import DummyCaster
import OrderIds
import ClosureTimers
import ACR_TagSystem
import ACR_Effects

public real array cloudAbsorbValue

init
    cloudActivate()

// ━━━━━━━━━━━━ [Activate Ability] ━━━━━━━━━━━━

function cloudActivate ()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_SPELL_EFFECT)
    ..addAction() ->
        if GetSpellAbilityId() == CLOUD_VONGOLA_ABILITY
            let caster = GetTriggerUnit()
            let id = caster.getUserData()
            let sfx = AddSpecialEffectTarget(CLOUD_EFFECT, caster, "chest")
            cloudAbsorbValue[id] = ((caster.getAgi(true) * 5) + ((caster.getArmor()) * 6))
            new DummyCaster()
            ..owner(caster.getOwner())
            ..origin(caster.getPos())
            ..castTarget(CLOUD_RING_DUMMY_SPELL, 1, OrderIds.bloodlust, caster)
            var count = 0
            doPeriodically(0.01) (CallbackPeriodic cb) ->
                if caster.hasTagPauseEX() == false and caster.isPaused() == false 
                    count++
                if cloudAbsorbValue[id] == 0                                        
                    caster.removeAbility('B06K')
                    caster.removeAbility('B06N')
                    sfx.destr()
                    destroy cb    
                if count == 300                
                    caster.removeAbility('B06K')
                    caster.removeAbility('B06N')
                    cloudAbsorbValue[id] = 0
                    sfx.destr()
                    destroy cb 
    
        else if GetSpellAbilityId() == CLOUD_ARCO_ABILITY
            let caster = GetTriggerUnit()
            let id = caster.getUserData()
            let sfx = AddSpecialEffectTarget(CLOUD_EFFECT, caster, "chest")            
            cloudAbsorbValue[id] = ((caster.getAgi(true) * 8) + ((caster.getArmor()) * 6))
            new DummyCaster()
            ..owner(caster.getOwner())
            ..origin(caster.getPos())
            ..castTarget(CLOUD_ARCO_DUMMY_SPELL, 1, OrderIds.bloodlust, caster)
            var count = 0
            doPeriodically(0.01) (CallbackPeriodic cb) ->
                if caster.hasTagPauseEX() == false and caster.isPaused() == false 
                    count++
                if cloudAbsorbValue[id] == 0                                    
                    caster.removeAbility('B06N')
                    caster.removeAbility('B06K')
                    sfx.destr()
                    destroy cb    
                if count == 500            
                    caster.removeAbility('B06N')
                    caster.removeAbility('B06K')
                    cloudAbsorbValue[id] = 0
                    sfx.destr()
                    destroy cb 