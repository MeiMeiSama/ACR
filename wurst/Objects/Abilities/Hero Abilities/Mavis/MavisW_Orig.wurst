package MavisW_Orig
import DamageEvent
import AbilityGlobals
import ObjectDefinitions
import ChannelAbilityPreset
import UnitIds
import main
import ACR_Stun
import ClosureForGroups

unit mavis
unit dummyUnit
vec2 spellPos
vec2 mavisPos
integer mavisWInt
group mavisWGroup

@compiletime function createAbility()
    new ChannelAbilityPreset(MAVIS_W, 5, true)
        ..presetTargetTypes(Targettype.POINT)
        ..setAnimationNames("11111111")
        ..setButtonPositionNormalX(1)
        ..setButtonPositionNormalY(2)
        ..setButtonPositionResearchX(1)
        ..setButtonPositionResearchY(0)
        ..setIconNormal("ReplaceableTextures\\CommandButtons\\BTNSpiritWolf.blp")
        ..setIconResearch("ReplaceableTextures\\CommandButtons\\BTNSpiritWolf.blp")
        ..setMissileSpeed(99999)
        ..setHeroAbility(true)
        ..setHotkeyNormal("W")
        ..setHotkeyLearn("W")
        ..setLevels(5)
        ..setLevelSkipRequirement(2)
        ..presetArtDuration(lvl -> 0)
        ..presetBaseOrderID(lvl -> "possession")
        ..presetDisableOtherAbilities(lvl -> false)
        ..presetFollowThroughTime(lvl -> 0)
        ..presetCastRange(lvl -> 2000)
        ..presetCooldown(lvl -> 50)
        ..presetManaCost(lvl -> 70)
        ..presetTargetsAllowed(lvl -> "enemy,ground,air,neutral")
        ..presetTooltipNormal(lvl -> "Howl of the Illusory Wolf|r")
        ..presetTooltipNormalExtended(lvl -> "Mavis W Desc|r")
        ..setTooltipLearn("Learn W|r")
        ..setTooltipLearnExtended("Learning W|r")
    new UnitDefinition(MAVIS_W_DUMMY, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\GodBoy_Enelwolf01.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")

    new UnitDefinition(MAVIS_W2_DUMMY, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("_")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")  

function initTrig_MavisW_Orig()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_SPELL_EFFECT)
    ..addCondition(Condition(function mavisCondition))
    ..addAction() ->
        mavis=GetTriggerUnit()
        spellPos = vec2(GetSpellTargetX(), GetSpellTargetY())
        mavisPos = mavis.getPos()
        mavis.setInvulnerable(true)
        mavis.pause()
        SetUnitAnimation(mavis, "spell")
        soundPlay("war3mapImported\\Mavis W.mp3", 0, 0)
        dummyUnit = createUnit(mavis.getOwner(), MAVIS_W_DUMMY, mavisPos, mavisPos.angleTo(spellPos))
        SetUnitScale(dummyUnit,0.80,0.80,0.80)
        SetUnitTimeScalePercent(dummyUnit, 80)
        if mavisWGroup == null
            mavisWGroup = CreateGroup()
        mavisWInt=0
        CreateTimer()..startPeriodic(0.03, function mavisWEnd)

function mavisWEnd()
    mavisWInt=mavisWInt+60
    mavis.setInvulnerable(false)
    mavis.unpause()
    if dummyUnit.getPos().distanceTo(spellPos) <= 40 or mavisWInt  >= 1350
        addEffect("war3mapImported\\EarthShock.mdx", dummyUnit.getPos())
        ..setScale(0.70)
        ..destr()
        let u = createUnit(mavis.getOwner(), MAVIS_W2_DUMMY, dummyUnit.getPos())
        u.setTimedLife(1)
        dummyUnit.remove()
        GetExpiredTimer().destr()
        mavisWGroup.clear()    
    else
        dummyUnit.setFacing(dummyUnit.getPos().angleTo(spellPos))
        dummyUnit.setPos(dummyUnit.getPos().polarOffset(dummyUnit.getPos().angleTo(spellPos), 80))
        forUnitsInRange(dummyUnit.getPos(), 400) (unit victim) ->
            if victim.isType(UNIT_TYPE_STRUCTURE)==false and victim.isEnemyOf(mavis)==true and mavisWGroup.has(victim) == false and victim.isAlive()==true and victim.isInvulnerable() == false
                DamageEvent.setNextDamageId(DAMAGE_ABILITY_W)
                DamageEvent.setNextDamageFromCode()
                UnitDamageTargetBJ(mavis, victim,(((GetUnitAbilityLevel(mavis,MAVIS_W)+1))*(GetHeroInt(mavis,true)).toReal()),ATTACK_TYPE_MAGIC,DAMAGE_TYPE_MAGIC)
                acrStun(mavis, victim, 0.7)
                mavisWGroup.add(victim)
    // if dummyUnit.getPos().distanceTo(spellPos) <= 40 or mavisWInt  >= 1350
    //     forUnitsInRange(dummyUnit.getPos(), 400) (unit victim) ->
    //         if victim.isType(UNIT_TYPE_STRUCTURE)==false and victim.isEnemyOf(mavis)==true and victim.isAlive()==true and victim.isInvulnerable() == false
    //             DamageEvent.setNextDamageId(DAMAGE_ABILITY_W)
    //             DamageEvent.setNextDamageFromCode()
    //             UnitDamageTargetBJ(mavis, victim,(((GetUnitAbilityLevel(mavis,MAVIS_W)+1))*(GetHeroInt(mavis,true)).toReal()),ATTACK_TYPE_MAGIC,DAMAGE_TYPE_MAGIC)
    //             acrStun(mavis, victim, 0.7)
    //     addEffect("war3mapImported\\EarthShock.mdx", dummyUnit.getPos())
    //     ..setScale(0.70)
    //     ..destr()
    //     dummyUnit.remove()
    //     GetExpiredTimer().destr()
    //     mavis=null
    //     mavisWInt=0    
    // else
    //     dummyUnit.setFacing(dummyUnit.getPos().angleTo(spellPos))
    //     dummyUnit.setPos(dummyUnit.getPos().polarOffset(dummyUnit.getPos().angleTo(spellPos), 80))
        
function mavisCondition() returns boolean
    return GetSpellAbilityId() == MAVIS_W 

init
    initTrig_MavisW_Orig()        
