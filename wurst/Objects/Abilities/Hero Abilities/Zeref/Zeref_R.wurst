package Zeref_R
import DamageEvent
import AbilityGlobals
import ObjectDefinitions
import ChannelAbilityPreset
import UnitIds
import main
import ClosureForGroups

unit zeref
unit enemy
unit dummy
unit dummy2
unit dummy3
unit dummy4
angle angle
angle kyokaAngle
vec2 spellPos
vec2 kyokaPos
effect effect1
effect effect2
integer zerefRInt
integer zerefRInt2

@compiletime function createAbility()
    new ChannelAbilityPreset(ZEREF_R, 3, true)
        ..presetTargetTypes(Targettype.UNIT)
        ..setAnimationNames("11111111")
        ..setButtonPositionNormalX(3)
        ..setButtonPositionNormalY(2)
        ..setButtonPositionResearchX(3)
        ..setButtonPositionResearchY(0)
        ..setIconNormal("ReplaceableTextures\\CommandButtons\\BTNAcidBomb.blp")
        ..setIconResearch("ReplaceableTextures\\CommandButtons\\BTNAcidBomb.blp")
        ..setMissileSpeed(99999)
        ..setHeroAbility(true)
        ..setHotkeyNormal("R")
        ..setHotkeyLearn("R")
        ..setLevels(3)
        ..setRequiredLevel(8)
        ..setLevelSkipRequirement(5)
        ..presetArtDuration(lvl -> 0)
        ..presetBaseOrderID(lvl -> "submerge")
        ..presetDisableOtherAbilities(lvl -> false)
        ..presetFollowThroughTime(lvl -> 0)
        ..presetCastRange(lvl -> 2000)
        ..presetCooldown(lvl -> 50)
        ..presetManaCost(lvl -> 70)
        ..presetTargetsAllowed(lvl -> "enemy,ground,air,neutral")
        ..presetTooltipNormal(lvl -> "Kyoka|r")
        ..presetTooltipNormalExtended(lvl -> "Zeref R Desc|r")
        ..setTooltipLearn("Kyoka|r")
        ..setTooltipLearnExtended("Learning R|r")
    new UnitDefinition(ZEREF_R_DUMMY, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\Kyoka.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(ZEREF_R_DUMMY2, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\KyokaChains.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(ZEREF_R_DUMMY3, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\KyokaCircle.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_") 
    new UnitDefinition(ZEREF_R_DUMMY4, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(0.70)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\KyokaArrow.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")       

init
    initTrig_ZerefR_Orig()     

function initTrig_ZerefR_Orig()
    CreateTrigger()
    ..registerAnyUnitEvent(EVENT_PLAYER_UNIT_SPELL_EFFECT)
    ..addAction() ->
        if GetSpellAbilityId() == ZEREF_R
            zeref=GetTriggerUnit()
            enemy=GetSpellTargetUnit()
            spellPos = GetSpellTargetUnit().getPos()
            zeref.setInvulnerable(true)
            zeref.pause()
            enemy.setInvulnerable(true)
            enemy.pause()
            zeref.setPos(zeref.getPos().polarOffset(zeref.getPos().angleTo(enemy.getPos()), (zeref.getPos().distanceTo(enemy.getPos()) -650)))
            SetUnitAnimation(zeref, "spell")
            dummy = createUnit(zeref.getOwner(), ZEREF_R_DUMMY, zeref.getPos().moveTowards(zeref.getPos(), 200), zeref.getPos().angleTo(spellPos))
            ..setScale(1.6)
            ..setAnimation("Spell")
            kyokaPos = dummy.getPos()
            angle = dummy.getPos().angleTo(spellPos)
            kyokaAngle = kyokaPos.angleTo(spellPos)
            soundPlay("war3mapImported\\Kyoka 3.mp3", 0, 0)
            zerefRInt = 0
            CreateTimer()..start(1.5, function zerefREnd)

function zerefREnd()
    dummy2 = createUnit(ZEREF_R_DUMMY2, spellPos)
    ..setScale(4.5)
    ..setTimeScale(80)
    ..setFacing(dummy2.getPos().angleTo(spellPos))
    ..setTimedLife(6)
    CreateTimer()..start(2, function kyokaMov) 

function zerefREnd2()
    soundPlay("war3mapImported\\Kyoka 7.mp3", 0, 0) 
    dummy.setPos(kyokaPos)
    dummy.setFacing(kyokaAngle)
    dummy.setAnimation("Spell One")
    dummy3 = createUnit(ZEREF_R_DUMMY3, spellPos)
    ..setScale(1.5)
    ..setTimeScale(80)
    ..setTimedLife(2)
    dummy4 = createUnit(ZEREF_R_DUMMY4, kyokaPos)
    ..setScale(1.5)
    ..setTimeScale(80)
    ..setFacing(dummy4.getPos().angleTo(spellPos))
    dummy.setAnimation("Spell Three")
    zerefRInt2 = 0
    CreateTimer()..startPeriodic(0.05, function zerefREnd3)

function zerefREnd3()
    zerefRInt2++
    if dummy4.getPos().distanceTo(spellPos) <= 20 or zerefRInt2 == 16  
        flashEffect("war3mapImported\\KyokaStar.mdx", spellPos)
        enemy.setInvulnerable(false)
        forUnitsInRange(spellPos, 400) (unit victim) ->
            if victim.isType(UNIT_TYPE_STRUCTURE)==false and victim.isEnemyOf(zeref)==true and victim.isAlive()==true and victim.isInvulnerable() == false
                DamageEvent.setNextDamageId(DAMAGE_ABILITY_R)
                DamageEvent.setNextDamageFromCode()
                UnitDamageTargetBJ(zeref,victim,(100*GetUnitAbilityLevel(zeref,ZEREF_R)).toReal(),ATTACK_TYPE_MAGIC,DAMAGE_TYPE_MAGIC)          
        GetExpiredTimer().destr()
        dummy4.remove()
        dummy.remove()
        zeref.setInvulnerable(false)
        zeref.unpause()
        enemy.unpause()
    else
        dummy4.setFacing(dummy4.getPos().angleTo(spellPos))
        dummy4.setPos(dummy4.getPos().polarOffset(dummy4.getPos().angleTo(spellPos), 60))

function kyokaMov()
    dummy.setPos(dummy.getPos().polarOffset(angle, (dummy.getPos().distanceTo(spellPos) +170)))
    dummy.setFacing(dummy.getPos().angleTo(spellPos))
    effect1 = addEffect("war3mapImported\\KyokaSlash.mdx", spellPos)
    ..setScale(1)
    CreateTimer()..startPeriodic(0.03, function kyokaAnim)
    
function kyokaAnim()
    zerefRInt++
    if zerefRInt == 2
        soundPlay("war3mapImported\\Kyoka 111.mp3", 0, 0) 
        dummy.setAnimation("Spell")
        effect2 = addEffect("war3mapImported\\KyokaSlashes3.mdx", spellPos)
        ..setScale(1.5)
        ..destr()  
    if zerefRInt == 40
        dummy.setAnimation("Spell Four")
        effect2 = addEffect("war3mapImported\\KyokaSlashes3.mdx", spellPos)
        ..setScale(1.5)
        ..destr() 
    if zerefRInt == 82
        soundPlay("war3mapImported\\Kyoka 4.mp3", 0, 0)
        dummy.setAnimation("Spell")
        effect2 = addEffect("war3mapImported\\KyokaSlashes3.mdx", spellPos)
        ..setScale(1.5)
        ..destr() 
    if zerefRInt == 120
        dummy.setAnimation("Spell Four")
        effect2 = addEffect("war3mapImported\\KyokaSlashes3.mdx", spellPos)
        ..setScale(1.5)
        ..destr() 
    if zerefRInt == 140
        GetExpiredTimer().destr()
        effect1.destr()
        effect2.destr()
        CreateTimer()..start(0.50, function zerefREnd2)