package Misogi_Thai_W
import main
import ObjectDefinitions
import ChannelAbilityPreset
import UnitIds
import DamageEvent
import AbilityGlobals
import ACR_Library

unit misogiWCaster
unit misogiWTarget
integer misogiWInt
unit misogiEffect1

@compiletime function createAbility()
    new ChannelAbilityPreset(MISOGI_THAI_W, 5, true)
        ..presetTargetTypes(Targettype.UNIT)
        ..setAnimationNames("11111111")
        ..setButtonPositionNormalX(1)
        ..setButtonPositionNormalY(2)
        ..setButtonPositionResearchX(1)
        ..setButtonPositionResearchY(0)
        ..setIconNormal("ReplaceableTextures\\CommandButtons\\BTNImpale.blp")
        ..setIconResearch("ReplaceableTextures\\CommandButtons\\BTNImpale.blp")
        ..setMissileSpeed(99999)
        ..setHeroAbility(true)
        ..setHotkeyNormal("W")
        ..setHotkeyLearn("W")
        ..setLevels(5)
        ..setLevelSkipRequirement(2)        
        ..presetArtDuration(lvl -> 0)
        ..presetBaseOrderID(lvl -> "possession")
        ..presetDisableOtherAbilities(lvl -> false)
        ..presetFollowThroughTime(lvl -> 0)
        ..presetCastRange(lvl -> 2000)
        ..presetCooldown(lvl -> 50)
        ..presetManaCost(lvl -> 70)
        ..presetTargetsAllowed(lvl -> "enemy,ground,air,neutral")
        ..presetTooltipNormal(lvl -> "Misog W Title|r")
        ..presetTooltipNormalExtended(lvl -> "Misogi W Desc|r")
        ..setTooltipLearn("Learn W|r")
        ..setTooltipLearnExtended("Learning W|r")
    new UnitDefinition(MISOGI_THAI_W_DUMMY_1, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\BloodEX-Special-2.mdl")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(MISOGI_THAI_W_DUMMY_2, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\MisogiScrew1MDXReal.mdx")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")
    new UnitDefinition(MISOGI_THAI_W_DUMMY_3, UnitIds.wisp)
        ..setNormalAbilities(commaList('Avul', 'Aloc', 'Amrf'))
        ..setAnimationCastBackswing(0)
        ..setDeathTimeseconds(0.1)
        ..setScalingValue(4)
        ..setUnitClassification("_")
        ..setArtSpecial("_")
        ..setHasWaterShadow(false)
        ..setMaximumPitchAngledegrees(0)
        ..setMaximumRollAngledegrees(0)
        ..setModelFile("war3mapImported\\dummy2.mdl")
        ..setArtSpecial("_")
        ..setArmorType(ArmorType.Unarmored)
        ..setPlaceableInEditor(false)
        ..setMovementHeight(20)
        ..setSpeedBase(100)
        ..setTurnRate(3)
        ..setMovementType(MovementType.Fly)
        ..setCollisionSize(0)
        ..setUnitSoundSet("_")
        ..setCanFlee(false)
        ..setFoodCost(0)
        ..setHideMinimapDisplay(true)
        ..setHitPointsMaximumBase(60)
        ..setHitPointsRegenerationRate(-1)
        ..setHitPointsRegenerationType("Always")
        ..setStockMaximum(1)
        ..setStockReplenishInterval(1)
        ..setStructuresBuilt("_")
        ..setUpgradesUsed("_")
        ..setHotkey("_")
        ..setName("effect dummy")
        ..setTooltipBasic("_")
        ..setTooltipExtended("_")

function misogiW4 ()
    unit u
    misogiWInt=misogiWInt+1
    PauseUnit(misogiWCaster,true)
    SetUnitInvulnerable(misogiWCaster,true)
    PauseUnit(misogiWTarget,true)
    SetUnitInvulnerable(misogiWTarget,true)
    if misogiWInt<55
        SetUnitFacing(misogiWCaster,AngleBetweenPoints(GetUnitLoc(misogiWCaster),GetUnitLoc(misogiWTarget)))

    if misogiWInt>=55
        SetUnitFacing(misogiWCaster,AngleBetweenPoints(GetUnitLoc(misogiWTarget),GetUnitLoc(misogiWCaster)))

    if misogiWInt==45
        soundPlay("war3mapImported\\misogiWSEReal.wav", 0, 0)
        u=CreateUnitAtLoc(GetOwningPlayer(misogiWCaster),MISOGI_THAI_W_DUMMY_1,GetUnitLoc(misogiWTarget),GetRandomDirectionDeg())
        SetUnitScale(u,2.5,2.5,2.5)
        SetUnitTimeScalePercent(u,70)
        UnitApplyTimedLife(u,'BHwe',3.5)

    if misogiWInt==55
        soundPlay("war3mapImported\\misogiW2Real.mp3", 0, 0)
        SetUnitPositionLoc(misogiWCaster,PolarProjectionBJ(GetUnitLoc(misogiWTarget),300,AngleBetweenPoints(GetUnitLoc(misogiWTarget),GetUnitLoc(misogiWCaster))-180))
        misogiEffect1=CreateUnitAtLoc(GetOwningPlayer(misogiWCaster),MISOGI_THAI_W_DUMMY_2,GetUnitLoc(misogiWTarget),GetRandomDirectionDeg())
        SetUnitScale(misogiEffect1,3.5,3.5,3.5)
        SetUnitTimeScalePercent(misogiEffect1,0)
        UnitAddAbility(misogiEffect1,'Amrf')
        SetUnitFlyHeight(misogiEffect1,350,999999)
        SetUnitAnimationByIndex(misogiWCaster,2)
        SetUnitTimeScalePercent(misogiWCaster,100)

    if misogiWInt==125
        SetUnitTimeScalePercent(misogiEffect1,100)
        UnitApplyTimedLife(misogiEffect1,'BHwe',1.2)
        UnitAddAbility(misogiEffect1,'Amrf')
        SetUnitFlyHeight(misogiEffect1,0,999999)

    if misogiWInt>150
        DestroyTimer(GetExpiredTimer())
        soundPlay("war3mapImported\\misogiWSE2Real.wav", 0, 0)
        PauseUnit(misogiWCaster,false)
        SetUnitInvulnerable(misogiWCaster,false)
        PauseUnit(misogiWTarget,false)
        SetUnitInvulnerable(misogiWTarget,false)
        DamageEvent.setNextDamageId(DAMAGE_ABILITY_W)
        DamageEvent.setNextDamageFromCode()
        UnitDamageTargetBJ(misogiWCaster,misogiWTarget,(((GetUnitAbilityLevel(misogiWCaster,MISOGI_THAI_W)+1))*(GetHeroAgi(misogiWCaster,true)).toReal()),ATTACK_TYPE_MAGIC,DAMAGE_TYPE_MAGIC)
        acrStun(misogiWCaster, misogiWTarget, 0.7)
        u=CreateUnitAtLoc(GetOwningPlayer(misogiWCaster),MISOGI_THAI_W_DUMMY_1,GetUnitLoc(misogiWTarget),GetRandomDirectionDeg())
        SetUnitScale(u,2.5,2.5,2.5)
        UnitApplyTimedLife(u,'BHwe',2.5)
        misogiWCaster=null
        misogiWTarget=null
        misogiEffect1=null
        misogiWInt=0

function misogiW3 ()
    let t=CreateTimer()
    soundPlay("war3mapImported\\misogiWReal.mp3", 0, 0)
    misogiWCaster=GetSpellAbilityUnit()
    misogiWTarget=GetSpellTargetUnit()
    PauseUnit(misogiWCaster,true)
    SetUnitInvulnerable(misogiWCaster,true)
    PauseUnit(misogiWTarget,true)
    SetUnitInvulnerable(misogiWTarget,true)
    SetUnitPositionLoc(misogiWCaster,PolarProjectionBJ(GetUnitLoc(misogiWTarget),175,AngleBetweenPoints(GetUnitLoc(misogiWTarget),GetUnitLoc(misogiWCaster))))
    SetUnitAnimationByIndex(misogiWCaster,7)
    SetUnitTimeScalePercent(misogiWCaster,150)
    misogiWInt=0
    TimerStart(t,.02,true,function misogiW4)

function misogiW2 () returns boolean
    return GetSpellAbilityId() == MISOGI_THAI_W

function misogiW1 ()
    let t = CreateTrigger()
    TriggerRegisterAnyUnitEventBJ(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    TriggerAddCondition(t,Condition(function misogiW2))
    TriggerAddAction(t,function misogiW3)

init
    misogiW1()